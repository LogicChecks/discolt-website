<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #2c2f33;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
        }

        .container {
            text-align: center;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 30px;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #40444b;
            border-top: 5px solid #5865f2;
            border-radius: 50%;
            margin: 0 auto 30px;
            animation: spin 1s linear infinite;
        }

        .checkmark {
            display: none;
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
        }

        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke: #5865f2;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark-check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke: #5865f2;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.6s forwards;
        }

        .error-icon {
            display: none;
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
        }

        .error-cross {
            stroke: #ff4444;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }

        .message {
            display: none;
            font-size: 1.2rem;
            animation: fadeIn 0.5s forwards;
            margin-top: 20px;
        }

        .success { color: #5865f2; }
        .error { color: #ff4444; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        
        <svg class="checkmark" id="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" stroke-width="3"/>
            <path class="checkmark-check" fill="none" stroke-width="3" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>

        <svg class="error-icon" id="error-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle cx="26" cy="26" r="25" fill="none" stroke="#ff4444" stroke-width="3"/>
            <path class="error-cross" fill="none" stroke-width="3" d="M16 16 l20 20 M36 16 l-20 20"/>
        </svg>
        
        <h1 id="text">Verifying...</h1>
        <p class="message" id="message"></p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            showError('Invalid verification link');
        } else {
            performVerification();
        }

        // Generate canvas fingerprint
        function getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const text = 'Browser Fingerprint 123!@#';
                
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.textBaseline = 'alphabetic';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText(text, 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillText(text, 4, 17);
                
                return canvas.toDataURL();
            } catch (e) {
                return 'canvas_error';
            }
        }

        // Generate WebGL fingerprint
        function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (!gl) return 'no_webgl';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return debugInfo ? 
                    gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 
                    'no_debug_info';
            } catch (e) {
                return 'webgl_error';
            }
        }

        // Get installed fonts (basic check)
        function getFonts() {
            const baseFonts = ['monospace', 'sans-serif', 'serif'];
            const testFonts = [
                'Arial', 'Verdana', 'Times New Roman', 'Courier New',
                'Georgia', 'Palatino', 'Garamond', 'Comic Sans MS',
                'Trebuchet MS', 'Impact'
            ];
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const text = 'mmmmmmmmmmlli';
            const detected = [];
            
            const baseWidths = {};
            ctx.font = '72px ';
            baseFonts.forEach(baseFont => {
                ctx.font = '72px ' + baseFont;
                baseWidths[baseFont] = ctx.measureText(text).width;
            });
            
            testFonts.forEach(font => {
                let detected_font = false;
                baseFonts.forEach(baseFont => {
                    ctx.font = '72px ' + font + ', ' + baseFont;
                    const width = ctx.measureText(text).width;
                    if (width !== baseWidths[baseFont]) {
                        detected_font = true;
                    }
                });
                if (detected_font) {
                    detected.push(font);
                }
            });
            
            return detected.join(',');
        }

        // Simple hash function
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        async function performVerification() {
            try {
                // Collect all fingerprint data
                const components = {
                    canvas: getCanvasFingerprint(),
                    webgl: getWebGLFingerprint(),
                    fonts: getFonts(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    languages: navigator.languages.join(','),
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                    colorDepth: screen.colorDepth,
                    pixelRatio: window.devicePixelRatio,
                    userAgent: navigator.userAgent,
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack || 'unknown',
                    plugins: Array.from(navigator.plugins || []).map(p => p.name).join(',')
                };

                // Generate unique fingerprint by hashing all components
                const fingerprintString = JSON.stringify(components);
                const fingerprint = simpleHash(fingerprintString);

                const data = {
                    token: token,
                    fingerprint: fingerprint,
                    components: components
                };

                console.log('Fingerprint:', fingerprint);
                console.log('Components:', components);

                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const responseData = await response.json();
                console.log('Server response:', responseData);

                if (responseData.success) {
                    showSuccess();
                } else {
                    showError(responseData.reason || 'Verification failed');
                }

            } catch (error) {
                console.error('Verification error:', error);
                showError('An error occurred during verification');
            }
        }

        function showSuccess() {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('checkmark').style.display = 'block';
            document.getElementById('text').textContent = 'Verified!';
            
            const msg = document.getElementById('message');
            msg.className = 'message success';
            msg.textContent = 'You can close this window now';
            msg.style.display = 'block';
        }

        function showError(reason) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('error-icon').style.display = 'block';
            document.getElementById('text').textContent = 'Verification Failed';
            
            const msg = document.getElementById('message');
            msg.className = 'message error';
            
            if (reason === 'alt_detected') {
                msg.textContent = 'Alt account detected. Access denied.';
            } else {
                msg.textContent = reason;
            }
            
            msg.style.display = 'block';
        }
    </script>
</body>
</html>
